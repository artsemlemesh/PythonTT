{% load static %}
{% csrf_token %}  <!-- Add this line to include the CSRF token -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email List</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <h1>Email List</h1>

    <button id="start_email_import">Fetch Emails</button> <!-- Button to trigger email fetching -->
    
    <div>
        <progress id="progress-bar" value="0" max="100" style="width: 100%;"></progress>
        <span id="status-text">Ready to fetch emails.</span>
    </div>
    <table>
        <thead>
            <tr>
                <th>Account</th>
                <th>Subject</th> <!-- Uncommented to display the subject -->
                <th>Sent Date</th>
                <th>Received Date</th> <!-- Added to display received date -->
                <th>Body</th>
                <th>Attachments</th>
            </tr>
        </thead>
        <tbody id="email-list">
            {% for email in emails %}
            <tr>
                <td>{{ email.account }}</td>
                <td>{{ email.subject | truncatechars:20 }}</td> <!-- Added subject field -->
                <td>{{ email.sent_date|date:"F j, Y, g:i a" }}</td>  <!-- Custom format for sent_date -->
                <td>{{ email.received_date|date:"F j, Y, g:i a" }}</td>  <!-- Custom format for received_date -->
                <td>{{ email.body | truncatechars:30 }}</td>
                <td>{{ email.attachments }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        const emailSocket = new WebSocket('ws://' + window.location.host + '/ws/messages/');
    
        emailSocket.onopen = function() {
            console.log('WebSocket connection established');
        };
    
        emailSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log('Received data from WebSocket:', data); // Log received data for debugging
            console.log('Progress my console:', data.progress);
            if (data.progress !== undefined) {
                console.log(`Progress: ${data.progress}%`);

                document.getElementById('progress-bar').value = data.progress; // Update progress bar
                document.getElementById('status-text').innerText = `Checked emails: ${data.checked_count}`;
            }
            
            if (data.new_email) {
                // Ensure new_email is in the expected format
                console.log('New email received:', data.new_email);
                updateEmailTable(data.new_email);
            }
        };
    
        function updateEmailTable(email) {
            console.log('emailAAAA', email)
            const table = document.getElementById('email-list');
            const row = table.insertRow();
            row.insertCell(0).innerText = email.from || 'Unknown';  // Use 'Unknown' if from is undefined
            row.insertCell(1).innerText = email.subject || 'No subject';  // Use 'No subject' if subject is undefined
            row.insertCell(2).innerText = email.date_sent || 'Unknown';  // Use 'Unknown' if date_sent is undefined
            row.insertCell(3).innerText = email.received_date || 'Unknown'; // Use 'Unknown' if received_date is undefined
            row.insertCell(4).innerText = email.description || 'No content';  // Use 'No content' if description is undefined
            row.insertCell(5).innerText = email.attachments || 'No content';  // Use 'No content' if description is undefined
        }
    
        // Function to fetch emails
        function fetchEmails() {
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value; // Get CSRF token
            
            console.log('Fetching emails...'); // Log fetch initiation
            fetch('/emails/import/1/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken // Include CSRF token in the headers
                },
                body: JSON.stringify({ /* any necessary data, e.g., account ID */ })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Email fetch response:', data); // Log fetch response
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }
    
        // Attach the fetchEmails function to the button click
        document.getElementById('start_email_import').addEventListener('click', fetchEmails);
    </script>
</body>
</html>