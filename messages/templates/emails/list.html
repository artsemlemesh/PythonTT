{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email List</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <h1>Email List</h1>
    
    <div>
        <progress id="progress-bar" value="0" max="100" style="width: 100%;"></progress>
        <span id="status-text">Ready to fetch emails.</span>
    </div>
    <table>
        <thead>
            <tr>
                <th>Subject</th>
                <th>Date Sent</th>
                <th>From</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody id="email-list">
            {% for email in emails %}
            <tr>
                <td>{{ email.subject }}</td>
                <td>{{ email.date_sent }}</td>
                <td>{{ email.from }}</td>
                <td>{{ email.description }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        const emailSocket = new WebSocket('ws://' + window.location.host + '/ws/messages/');

        emailSocket.onopen = function() {
            // The WebSocket is now open, you can safely send messages
            fetchEmails(); // Call fetchEmails here to ensure it's sent after connection is open
        };
    
        emailSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.progress) {
                document.getElementById('progress-bar').value = data.progress; // Update progress bar
                document.getElementById('status-text').innerText = `Checked emails: ${data.checked_count}`;
            }
            if (data.new_email) {
                // Update email table with new emails
                updateEmailTable(data.new_email);
            }
        };
    
        function updateEmailTable(email) {
            const table = document.getElementById('email-list');
            const row = table.insertRow();
            row.insertCell(0).innerText = email.subject;
            row.insertCell(1).innerText = email.date_sent;
            row.insertCell(2).innerText = email.from;
            row.insertCell(3).innerText = email.description;
        }
    
        function fetchEmails() {
            if (emailSocket.readyState === WebSocket.OPEN) {
                emailSocket.send(JSON.stringify({
                    'action': 'fetch_emails',
                    'email_account_id': 1  // Replace with the actual account ID
                }));
            } else {
                console.error("WebSocket is not open. Current state: " + emailSocket.readyState);
            }
        }
    
    </script>
</body>
</html>