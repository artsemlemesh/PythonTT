{% load static %}
{% csrf_token %}  <!-- Add this line to include the CSRF token -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email List</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <h1>Email List</h1>

    <button id="start_email_import">Fetch Emails</button> <!-- Button to trigger email fetching -->
    
    <div>
        <progress id="progress-bar" value="0" max="100" style="width: 100%;"></progress>
        <span id="status-text">Ready to fetch emails.</span>
    </div>
    <table>
        <thead>
            <tr>
                <th>Account</th>
                {% comment %} <th>Subject</th> {% endcomment %}
                <th>Sent date</th>
                {% comment %} <th>Received date</th> {% endcomment %}
                <th>Body</th>
            </tr>
        </thead>
        <tbody id="email-list">
            {% for email in emails %}
            <tr>
                <td>{{ email.account }}</td>
                {% comment %} <td>{{ email.subject }}</td> {% endcomment %}
                <td>{{ email.sent_date }}</td>
                {% comment %} <td>{{ email.received_date }}</td> {% endcomment %}
                <td>{{ email.body }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        const emailSocket = new WebSocket('ws://' + window.location.host + '/ws/messages/');

        emailSocket.onopen = function() {
            console.log('WebSocket connection established');
        };

        emailSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.progress) {
                document.getElementById('progress-bar').value = data.progress; // Update progress bar
                document.getElementById('status-text').innerText = `Checked emails: ${data.checked_count}`;
            }
            if (data.new_email) {
                // Update email table with new emails
                updateEmailTable(data.new_email);
            }
        };

        function updateEmailTable(email) {
            const table = document.getElementById('email-list');
            const row = table.insertRow();
            row.insertCell(0).innerText = email.subject;
            row.insertCell(1).innerText = email.date_sent;
            row.insertCell(2).innerText = email.from;
            row.insertCell(3).innerText = email.description;
        }

        // Function to fetch emails
        function fetchEmails() {
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value; // Get CSRF token
        
            fetch('/emails/import/1/', {
                method: 'POST', // Use POST method
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken // Include CSRF token in the headers
                },
                body: JSON.stringify({ /* any necessary data, e.g., account ID */ })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log(data);
                // Optionally handle the response, e.g., update UI or notify the user
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }

        // Attach the fetchEmails function to the button click
        document.getElementById('start_email_import').addEventListener('click', fetchEmails);
    </script>
</body>
</html>
